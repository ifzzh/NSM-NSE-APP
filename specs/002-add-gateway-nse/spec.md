# Feature Specification: IP网关NSE

**Feature Branch**: `002-add-gateway-nse`
**Created**: 2025-11-02
**Status**: Draft
**Input**: User description: "模仿cmd-nse-firewall-vpp-refactored，创建一个gateway。gateway不需要像防火墙一样读取ip+端口甚至其他内容，只根据数据包的ip做简单的放行/禁止。gateway作为NSM中的NSE，其使用方法类似于防火墙，在创建时会提供一个config配置文件来设置相应的放行策略"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基于IP的访问控制 (Priority: P1)

作为网络管理员,我希望部署一个IP网关NSE,通过配置文件设置允许或禁止特定IP地址的访问策略,以便实现简单的网络访问控制。

**Why this priority**: 这是网关的核心功能,实现基于IP地址的流量过滤是最基本的需求,是MVP的必要组成部分。

**Independent Test**: 通过创建包含IP白名单/黑名单的配置文件,部署网关NSE到NSM环境,发送来自不同源IP的数据包,验证只有配置允许的IP能够通过网关,其他IP的数据包被阻止。

**Acceptance Scenarios**:

1. **Given** 网关配置文件中定义了允许列表（例如允许192.168.1.0/24）,**When** 来自192.168.1.100的数据包到达网关,**Then** 数据包被放行
2. **Given** 网关配置文件中定义了禁止列表（例如禁止10.0.0.5）,**When** 来自10.0.0.5的数据包到达网关,**Then** 数据包被阻止
3. **Given** 网关配置文件同时包含允许和禁止列表,**When** 来自未在任何列表中的IP地址的数据包到达,**Then** 根据默认策略（允许或禁止）处理数据包

---

### User Story 2 - 网关作为NSE在NSM中注册和运行 (Priority: P1)

作为Kubernetes集群运维人员,我希望能够将IP网关作为NSE部署到NSM环境中,让它能够自动注册到NSM注册表并接收网络服务请求。

**Why this priority**: 这是网关作为NSE的基本能力,必须能够正确集成到NSM生态系统中才能发挥作用。

**Independent Test**: 通过部署网关容器到Kubernetes集群,检查网关NSE是否成功注册到NSM注册表,并能够响应网络服务请求。

**Acceptance Scenarios**:

1. **Given** 网关容器镜像和Kubernetes部署清单,**When** 执行 `kubectl apply` 部署网关,**Then** 网关Pod成功启动并进入Running状态
2. **Given** 运行中的网关NSE,**When** 查询NSM注册表,**Then** 能够看到网关NSE的注册信息（名称、服务类型、端点URL）
3. **Given** 注册成功的网关NSE,**When** 客户端通过NSM请求网络服务,**Then** 网关能够接收请求并建立连接

---

### User Story 3 - 通过配置文件灵活定义策略 (Priority: P2)

作为网络管理员,我希望能够通过编辑YAML配置文件来定义和更新IP访问策略,而无需重新编译或修改网关代码。

**Why this priority**: 灵活的配置机制提升了网关的可用性,但核心过滤逻辑更重要,因此优先级为P2。

**Independent Test**: 通过修改配置文件中的IP列表（添加、删除、修改IP地址）,重启网关服务,验证新策略生效且网关按照新配置过滤流量。

**Acceptance Scenarios**:

1. **Given** 网关配置文件定义了初始IP白名单,**When** 管理员修改配置文件添加新的IP地址,**Then** 重启网关后新IP地址的流量被允许通过
2. **Given** 网关配置文件使用CIDR表示法（如10.0.0.0/24）,**When** 网关加载配置,**Then** 整个网段内的所有IP地址都按照配置的策略处理
3. **Given** 网关配置文件包含无效的IP地址格式,**When** 网关启动并加载配置,**Then** 记录错误日志并拒绝启动,避免运行在不确定的状态

---

### User Story 4 - 复用firewall-vpp的架构和通用模块 (Priority: P1)

作为NSE开发者,我希望网关能够复用firewall-vpp-refactored中已解耦的通用代码（配置管理、gRPC服务器、NSM注册）,以便减少重复代码并保持架构一致性。

**Why this priority**: 这是遵循项目宪章"解耦框架标准化"原则的必要要求,确保网关项目的可维护性。

**Independent Test**: 通过代码审查和目录结构检查,验证网关项目使用了firewall-vpp的通用包（如pkg/config、pkg/server、pkg/registry）,而不是重新实现相同功能。

**Acceptance Scenarios**:

1. **Given** firewall-vpp-refactored的通用包（pkg/config等）,**When** 网关项目引用这些包,**Then** 网关无需重新实现配置加载、服务器启动等通用逻辑
2. **Given** 网关的业务逻辑代码（IP过滤规则）,**When** 检查代码位置,**Then** 业务逻辑被隔离在独立的gateway包中（如pkg/gateway或internal/gateway）
3. **Given** 网关项目的目录结构,**When** 与firewall-vpp对比,**Then** 两者遵循相同的目录布局标准（cmd/、pkg/、internal/、tests/、docs/）

---

### Edge Cases

- 如果配置文件中同时包含允许和禁止某个IP地址,如何处理优先级？（假设：禁止策略优先于允许策略,即"黑名单优先"）
- 如果数据包的源IP地址无法被识别（例如被伪造或来自不支持的协议）,网关如何处理？（假设：按默认拒绝策略处理,并记录警告日志）
- 如果网关在高负载情况下处理大量数据包,性能是否会显著下降？（假设：基于VPP的高性能数据平面能够支持至少1Gbps的吞吐量,性能优化不在本次范围内）
- 如果配置文件非常大（例如包含10000条IP规则）,网关启动时间和内存占用是否可接受？（假设：支持最多1000条规则,超出范围需要在文档中说明限制）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 网关必须能够从YAML格式的配置文件中加载IP访问策略,包括允许列表（白名单）和禁止列表（黑名单）
- **FR-002**: 网关必须支持单个IP地址（如192.168.1.10）和CIDR网段（如10.0.0.0/24）两种IP表示法
- **FR-003**: 网关必须根据配置的策略,对进入的数据包进行源IP地址匹配,放行或阻止符合条件的数据包
- **FR-004**: 网关必须支持默认策略配置,当数据包的源IP不在任何规则中时,按照默认策略（允许或禁止）处理
- **FR-005**: 网关必须在检测到无效的配置（如格式错误的IP地址、冲突的规则）时拒绝启动,并输出清晰的错误信息
- **FR-006**: 网关必须作为NSE注册到NSM注册表,包含网关的名称、提供的网络服务类型和端点URL
- **FR-007**: 网关必须能够响应NSM客户端的连接请求,建立网络服务连接
- **FR-008**: 网关必须使用VPP作为数据平面,实现高性能的数据包处理
- **FR-009**: 网关必须复用firewall-vpp-refactored的通用模块（配置管理、gRPC服务器、NSM注册、VPP连接管理）
- **FR-010**: 网关必须将IP过滤业务逻辑与通用代码分离,放置在独立的gateway包中
- **FR-011**: 网关必须记录关键操作日志（启动、配置加载、规则应用、连接建立、异常事件）,使用结构化日志格式
- **FR-012**: 网关必须支持通过环境变量配置通用参数（如日志级别、NSM注册地址、gRPC监听端口）
- **FR-013**: 网关必须能够构建为独立的容器镜像,包含所有运行时依赖
- **FR-014**: 网关必须遵循项目宪章的目录结构规范,使用cmd/、pkg/、internal/、tests/、docs/等标准目录

### Key Entities

- **IP访问策略（IP Access Policy）**: 定义网关的过滤规则,包含允许列表和禁止列表。每条规则包含IP地址或CIDR网段,以及动作（允许/禁止）。策略还包含默认动作（当数据包不匹配任何规则时的处理方式）。

- **网关配置（Gateway Configuration）**: 包含网关运行所需的所有配置参数,分为通用配置（名称、日志级别、NSM连接地址）和业务配置（IP访问策略）。配置从环境变量和YAML文件中加载。

- **网关端点（Gateway Endpoint）**: 网关在NSM中的服务端点表示,包含端点名称、提供的网络服务列表、端点URL等属性。是NSM注册的核心实体。

- **数据包过滤器（Packet Filter）**: 网关的核心业务逻辑组件,负责检查进入数据包的源IP地址,根据配置的策略决定是否放行。与VPP集成,实现高性能的数据包匹配。

- **VPP连接（VPP Connection）**: 网关与VPP数据平面的连接实例,负责向VPP下发过滤规则、处理VPP事件。复用firewall-vpp的VPP连接管理模块。

- **网络服务端点（Network Service Endpoint）**: 表示NSM中的服务提供者,网关作为NSE的一种实现,提供基于IP过滤的网络服务。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 网关能够在2秒内完成启动并成功注册到NSM注册表
- **SC-002**: 网关能够正确处理包含100条IP规则的配置文件,启动时间不超过5秒
- **SC-003**: 网关的IP过滤功能准确率达到100%（所有配置的规则都被正确执行）
- **SC-004**: 开发者能够在2小时内基于网关代码和文档理解其架构,并能够修改IP过滤逻辑
- **SC-005**: 网关的代码复用率达到60%以上（通过复用firewall-vpp的通用模块实现）
- **SC-006**: 网关的容器镜像大小不超过500MB（与firewall-vpp镜像大小相近）
- **SC-007**: 网关能够支持至少1Gbps的网络吞吐量（基于VPP数据平面的性能）
- **SC-008**: 网关的核心业务逻辑（IP过滤）的单元测试覆盖率达到80%以上
- **SC-009**: 网关在配置错误时能够100%检测并拒绝启动,不出现运行时崩溃
- **SC-010**: 网关项目的目录结构和代码风格与firewall-vpp保持90%以上的一致性（通过代码审查评估）

## Assumptions

1. **架构基础**: 假设firewall-vpp-refactored的解耦工作已完成,通用模块（pkg/config、pkg/server、pkg/registry、pkg/vpp）可直接复用
2. **Go语言版本**: 假设使用Go 1.23.8,与firewall-vpp严格保持一致（遵循项目宪章）
3. **VPP版本**: 假设使用与firewall-vpp相同的VPP版本,不需要额外的VPP插件或配置
4. **NSM SDK版本**: 假设使用与firewall-vpp相同的NSM SDK版本,保持依赖一致性
5. **配置格式**: 假设配置文件使用YAML格式,与firewall-vpp的配置方式保持一致
6. **默认策略**: 假设默认拒绝策略（未在配置中明确允许的IP都被阻止）,可通过配置文件修改
7. **IP匹配规则**: 假设黑名单优先于白名单（如果同一IP既在允许列表又在禁止列表中,执行禁止动作）
8. **性能要求**: 假设网关主要用于中小规模网络环境（100-1000个连接）,不需要优化到10Gbps以上的极致性能
9. **部署环境**: 假设网关部署在Kubernetes集群中,使用容器化运行方式
10. **文档语言**: 假设文档和注释使用简体中文,代码标识符使用英文（遵循项目宪章）
11. **测试环境**: 假设开发者有本地Go开发环境和Docker环境,可以进行本地构建和测试
12. **IP协议**: 假设仅处理IPv4地址,IPv6支持不在本次范围内

## Dependencies

1. **firewall-vpp-refactored项目**: 必须完成firewall-vpp的解耦工作（specs/001）,网关才能复用通用模块
2. **NSM SDK**: 依赖networkservicemesh SDK的稳定版本,与firewall-vpp保持一致
3. **VPP**: 依赖VPP数据平面及vpphelper库,用于高性能数据包处理
4. **Go标准库**: 依赖Go的net包进行IP地址解析和CIDR匹配
5. **配置解析库**: 依赖yaml.v3或viper库进行YAML配置文件解析（与firewall-vpp保持一致）
6. **日志库**: 依赖logrus或zap日志库（与firewall-vpp保持一致）
7. **容器运行时**: 依赖Docker或兼容的OCI运行时进行镜像构建和部署
8. **Kubernetes**: 依赖Kubernetes集群作为NSM的运行环境
9. **项目宪章**: 依赖项目宪章（.specify/memory/constitution.md）的治理规则和架构标准

## Out of Scope

1. **端口过滤**: 不实现基于端口号的过滤（与防火墙的主要区别）
2. **协议过滤**: 不实现基于协议类型（TCP/UDP/ICMP等）的过滤
3. **状态检测**: 不实现有状态的数据包检查（如跟踪TCP连接状态）
4. **IPv6支持**: 不支持IPv6地址的过滤
5. **动态策略更新**: 不支持在网关运行时热更新策略,必须重启网关
6. **策略优先级排序**: 不支持复杂的规则优先级配置,按照简单的"黑名单优先"原则
7. **流量统计**: 不实现流量统计和监控功能（如记录每个IP的流量大小）
8. **负载均衡**: 不实现多网关实例间的负载均衡
9. **高可用**: 不实现网关的高可用和故障转移机制
10. **性能优化**: 不进行极致的性能优化（如10Gbps以上吞吐量）,基于VPP的默认性能即可
11. **Web管理界面**: 不提供Web或CLI管理界面,仅通过配置文件管理
12. **日志聚合**: 不集成日志聚合系统（如ELK）,仅输出标准日志
13. **告警通知**: 不实现主动告警和通知功能
14. **多租户**: 不实现多租户隔离和配额管理
