# IP网关策略配置示例 - 混合策略配置
#
# 使用场景：
# - 同时使用单个IP地址和CIDR网段
# - 复杂的访问控制需求
# - 多层级网络权限管理
#
# 应用此配置：
#   export NSM_IP_POLICY_CONFIG_PATH=/path/to/policy-mixed.yaml
#   或在Kubernetes中通过ConfigMap挂载

# 允许列表（白名单）
# 混合使用单个IP和CIDR网段
allowList:
  # === 内部网络（CIDR网段） ===
  - "10.0.0.0/8"          # 完整私有网段（企业内网）
  - "172.16.0.0/12"       # 私有网段（部门网络）
  - "192.168.0.0/16"      # 私有网段（办公室网络）

  # === 合作伙伴网络（CIDR网段） ===
  - "203.0.113.0/24"      # 合作伙伴A的网段
  - "198.51.100.0/24"     # 合作伙伴B的网段

  # === VIP客户（单个IP） ===
  - "8.8.8.8"             # Google公共DNS（示例：可信外部服务）
  - "1.1.1.1"             # Cloudflare DNS（示例：可信外部服务）
  - "52.1.2.3"            # AWS弹性IP（示例：云服务出口IP）

  # === 特定服务器（单个IP，使用/32显式标记） ===
  - "104.16.132.229/32"   # CDN节点IP
  - "151.101.1.194/32"    # GitHub服务器IP

  # === 动态IP范围（小型CIDR） ===
  - "100.64.0.0/16"       # ISP共享地址空间（CGN/CGNAT）

denyList:
  # === 临时封禁（单个IP） ===
  - "192.168.1.50"        # 被入侵的工作站
  - "10.5.6.100"          # 恶意行为检测的主机
  - "172.16.99.200"       # 违规访问的设备

  # === 隔离区域（CIDR网段） ===
  - "10.99.0.0/16"        # 隔离测试网段（不允许访问生产环境）
  - "192.168.250.0/24"    # 访客网络（不允许访问内部服务）

  # === 已知威胁（混合） ===
  - "45.142.120.0/22"     # 已知恶意IP段（示例）
  - "185.220.101.1"       # Tor出口节点（示例：如果不允许匿名访问）
  - "91.219.237.229/32"   # 已知扫描器IP

  # === 地理位置封禁（大型CIDR，示例） ===
  # 注意：实际使用时应使用完整的地理IP数据库
  - "223.0.0.0/8"         # 示例：某些国家/地区的IP段

# 默认动作
# 使用"deny"以确保只有显式允许的IP可以访问
defaultAction: "deny"

# ===== 配置说明 =====
#
# 1. 优先级规则：
#    黑名单 > 白名单 > 默认策略
#
#    即使某个IP在白名单的CIDR网段中，只要它也在黑名单中，
#    仍然会被拒绝访问。
#
# 2. 单个IP vs CIDR网段的选择：
#
#    使用单个IP的场景：
#    - VIP客户的固定IP
#    - 特定服务器的IP（如合作伙伴API服务器）
#    - 临时授权访问的IP
#    - 需要精确控制的情况
#
#    使用CIDR网段的场景：
#    - 内部网络（如10.0.0.0/8）
#    - 整个部门或办公室的网段
#    - 合作伙伴的子网
#    - 云服务商的IP段
#
# 3. 混合策略的优势：
#    - 灵活性：可以同时管理大型网段和精确IP
#    - 维护性：CIDR减少规则数量，单个IP便于快速调整
#    - 安全性：结合粗粒度（网段）和细粒度（单IP）控制
#
# ===== 匹配示例 =====
#
# 假设使用此配置，以下是一些IP的匹配结果：
#
# 示例1: 内网主机
# 源IP: 10.5.6.7
# - 匹配白名单: ✅ 10.0.0.0/8
# - 匹配黑名单: ❌ 无
# - 结果: ✅ 允许
#
# 示例2: 被入侵的内网主机
# 源IP: 192.168.1.50
# - 匹配白名单: ✅ 192.168.0.0/16
# - 匹配黑名单: ✅ 192.168.1.50（精确匹配）
# - 结果: ❌ 拒绝（黑名单优先）
#
# 示例3: 隔离测试网段
# 源IP: 10.99.1.1
# - 匹配白名单: ✅ 10.0.0.0/8（大型网段）
# - 匹配黑名单: ✅ 10.99.0.0/16（隔离网段）
# - 结果: ❌ 拒绝（黑名单优先）
#
# 示例4: 可信外部服务
# 源IP: 8.8.8.8
# - 匹配白名单: ✅ 8.8.8.8（精确匹配）
# - 匹配黑名单: ❌ 无
# - 结果: ✅ 允许
#
# 示例5: 未知外部IP
# 源IP: 93.184.216.34
# - 匹配白名单: ❌ 无
# - 匹配黑名单: ❌ 无
# - 结果: ❌ 拒绝（应用defaultAction: deny）
#
# 示例6: Tor出口节点
# 源IP: 185.220.101.1
# - 匹配白名单: ❌ 无
# - 匹配黑名单: ✅ 185.220.101.1（精确匹配）
# - 结果: ❌ 拒绝（在黑名单中）
#
# 示例7: 合作伙伴网络
# 源IP: 203.0.113.50
# - 匹配白名单: ✅ 203.0.113.0/24
# - 匹配黑名单: ❌ 无
# - 结果: ✅ 允许
#
# ===== 实际应用场景 =====
#
# 场景1: 企业内部服务
# 需求：只允许内网和特定外部合作伙伴访问
# 方案：
#   allowList: 内网CIDR + 合作伙伴网段
#   denyList: 测试网段 + 临时封禁IP
#   defaultAction: deny
#
# 场景2: API网关
# 需求：允许注册客户的固定IP访问API
# 方案：
#   allowList: 客户固定IP列表（单个IP）
#   denyList: 滥用检测的IP
#   defaultAction: deny
#
# 场景3: 开发环境
# 需求：允许开发团队网段，拒绝生产环境访问
# 方案：
#   allowList: 开发网段（CIDR）
#   denyList: 生产网段（CIDR）
#   defaultAction: deny
#
# ===== 维护建议 =====
#
# 1. 定期审查白名单：
#    - 移除过期的合作伙伴IP
#    - 检查VIP客户IP是否变更
#    - 合并可以归并为CIDR的单个IP
#
# 2. 监控黑名单：
#    - 临时封禁的IP是否可以解除
#    - 威胁情报更新后添加新的恶意IP段
#    - 定期清理不再活跃的威胁IP
#
# 3. 规则优化：
#    - 如果多个单个IP属于同一网段，考虑改为CIDR
#    - 避免规则总数超过1000条限制
#    - 使用注释标记每条规则的用途和添加时间
#
# 4. 配置版本控制：
#    - 将配置文件纳入Git管理
#    - 每次修改添加commit message说明理由
#    - 使用分支管理不同环境的配置
#
# 5. 测试流程：
#    - 在测试环境先验证配置
#    - 使用DEBUG日志级别观察匹配结果
#    - 逐步推广到生产环境
#
# ===== 常见错误避免 =====
#
# 错误1: 忘记黑名单优先规则
# ❌ 错误理解：
#   allowList: ["192.168.1.0/24"]
#   denyList: ["192.168.1.50"]
#   → 认为192.168.1.50会被允许（因为在白名单网段中）
# ✅ 正确：
#   → 192.168.1.50会被拒绝（黑名单优先）
#
# 错误2: 单个IP未转换为/32
# ❌ 错误写法:
#   allowList: "192.168.1.100"  # 缺少列表标记
# ✅ 正确写法:
#   allowList:
#     - "192.168.1.100"          # 自动转为/32
#
# 错误3: CIDR网段过大导致安全风险
# ❌ 不安全:
#   allowList: ["0.0.0.0/0"]    # 允许所有IP（无防护）
# ✅ 安全:
#   allowList: ["10.0.0.0/8"]   # 仅允许特定网段
#
# 错误4: 默认允许策略 + 空黑名单
# ❌ 不安全:
#   allowList: []
#   denyList: []
#   defaultAction: "allow"       # 完全开放
# ✅ 安全:
#   defaultAction: "deny"        # 默认拒绝，显式授权
